@model socconvertor.Models.Home.HomeDashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    var crumbs = new List<socconvertor.Models.BreadcrumbItem>
    {
        new socconvertor.Models.BreadcrumbItem { Text = "Dashboard", Active = true }
    };
}

@await Html.PartialAsync("_Breadcrumb", crumbs)

<div class="container mt-2">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Success:</strong> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Sessions</h5>
                    <h2 class="text-primary">@Model.TotalSessions</h2>
                    <p class="text-muted mb-0">Split: @Model.SplitSessionsCount | Bulk: @Model.BulkSessionsCount</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">PDF Files</h5>
                    <h2 class="text-success">@Model.TotalPdfs</h2>
                    <p class="text-muted mb-0">Split: @Model.SplitPdfCount | Bulk: @Model.BulkPdfCount</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Storage Used</h5>
                    <h2 class="text-info">@Model.TotalSizeFormatted</h2>
                    <p class="text-muted mb-0">Across split and bulk roots</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">Actions</h5>
                    <div class="d-grid gap-2">
                        <a class="btn btn-primary btn-sm" href="@Url.Action("Index", "Pdf")"><i class="bi bi-upload"></i> Split PDFs</a>
                        <a class="btn btn-success btn-sm" href="@Url.Action("UploadZips", "BulkEmail")"><i class="bi bi-box"></i> Create Session (ZIP)</a>
                        <a class="btn btn-warning btn-sm" href="@Url.Action("InitiateManual", "BulkEmail")"><i class="bi bi-envelope"></i> Send Bulk Email</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Activity</h5>
        </div>
        <div class="card-body">
            @if (!(Model.RecentActivities?.Any() ?? false))
            {
                <div class="text-muted">No activity yet. Get started by splitting a PDF or uploading ZIPs.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Origin</th>
                                <th>Session ID</th>
                                <th>PDFs</th>
                                <th>Size</th>
                                <th>Last Modified</th>
                                <th class="text-end">Delete</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var s in Model.RecentActivities)
                            {
                                <tr>
                                    <td><span class="badge @(s.Origin == "split" ? "bg-primary" : "bg-dark")">@s.Origin.ToUpperInvariant()</span></td>
                                    <td><code>@s.Id</code></td>
                                    <td>@s.PdfCount</td>
                                    <td>@s.TotalSizeFormatted</td>
                                    <td>@s.LastModifiedUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                                    <td class="text-end">
                                        <form method="post" class="d-inline" asp-action="DeleteSession" asp-controller="@(s.Origin == "split" ? "Pdf" : "BulkEmail")">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="folderId" value="@s.Id" />
                                            <input type="hidden" name="returnUrl" value="@Url.Action("Index", "Home")" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete" onclick="return confirm('Delete session @s.Id ?');">
                                                <img src="~/delete.ico" alt="Delete" style="width:16px;height:16px;" />
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Queued Email Jobs</h5>
            <form method="post" asp-action="ClearJobs" asp-controller="BulkEmail" onsubmit="return confirm('Clear job history?');" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="onlyFinished" value="true" />
                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> Clear Finished</button>
            </form>
        </div>
        <div class="card-body">
            @if (!(Model.Jobs?.Any() ?? false))
            {
                <div class="text-muted">No queued or completed jobs.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Job ID</th>
                                <th>Status</th>
                                <th>Created (Local)</th>
                                <th>Sent</th>
                                <th>Failed</th>
                                <th>Deferred</th>
                                <th>Pending</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var j in Model.Jobs)
                            {
                                <tr>
                                    <td><code>@j.JobId</code></td>
                                    <td>
                                        <span class="badge @(j.Status == socconvertor.Models.Email.EmailDispatchJobStatus.Completed ? "bg-success" : j.Status == socconvertor.Models.Email.EmailDispatchJobStatus.Cancelled ? "bg-secondary" : j.Status == socconvertor.Models.Email.EmailDispatchJobStatus.Failed ? "bg-danger" : "bg-info")">@j.Status</span>
                                    </td>
                                    <td>@j.CreatedUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@j.SuccessCount</td>
                                    <td>@j.FailedCount</td>
                                    <td>@j.DeferredCount</td>
                                    <td>@j.PendingCount</td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a class="btn btn-outline-primary" href="@Url.Action("Progress","BulkEmail", new { jobId = j.JobId })" title="View Progress"><i class="bi bi-bar-chart"></i></a>
                                            @if (j.Status == socconvertor.Models.Email.EmailDispatchJobStatus.Queued || j.Status == socconvertor.Models.Email.EmailDispatchJobStatus.Running || j.Status == socconvertor.Models.Email.EmailDispatchJobStatus.PartiallyDeferred)
                                            {
                                                <form method="post" asp-action="CancelJob" asp-controller="BulkEmail" onsubmit="return confirm('Cancel job @j.JobId ?');" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="jobId" value="@j.JobId" />
                                                    <button type="submit" class="btn btn-outline-danger" title="Cancel"><i class="bi bi-x-circle"></i></button>
                                                </form>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>
