@{
    ViewData["Title"] = "Upload ZIPs";
    var crumbs = new List<socconvertor.Models.BreadcrumbItem>
    {
        new socconvertor.Models.BreadcrumbItem { Text = "Dashboard", Controller = "Home", Action = "Index" },
        new socconvertor.Models.BreadcrumbItem { Text = "Select Sessions", Controller = "BulkEmail", Action = "InitiateManual" },
        new socconvertor.Models.BreadcrumbItem { Text = "Upload ZIPs", Active = true }
    };
}

@await Html.PartialAsync("_Breadcrumb", crumbs)

<div class="container mt-3" id="uploadApp">
    <h2>Create Session from ZIPs</h2>
    <p class="text-muted">Drag & drop one or more ZIP files (SOA / INV / OD) or use the picker. Non-PDF entries skipped.</p>

    <div id="alerts" aria-live="polite"></div>

    <form id="zipForm" enctype="multipart/form-data" class="mb-3">
        @Html.AntiForgeryToken()
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Custom Code (optional 4–8 digits)</label>
                <input type="text" name="customCode" pattern="\d{4,8}" class="form-control" placeholder="e.g. 202412" />
            </div>
            <div class="col-md-8">
                <div id="dropZone" class="border border-dashed rounded p-4 text-center bg-light">
                    <p class="m-0"><strong>Drag & Drop ZIP files here</strong></p>
                    <p class="small text-muted mb-2">or click to select</p>
                    <input type="file" id="fileInput" name="files" accept=".zip" multiple hidden />
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="chooseBtn">Add ZIPs</button>
                    <span id="countBadge" class="badge bg-secondary ms-2">0 selected</span>
                </div>
            </div>
        </div>

        <div class="mt-3 small" id="fileList"></div>

        <div class="mt-3 d-flex align-items-center gap-3">
            <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>Upload & Create Session</button>
            <button type="button" class="btn btn-secondary" id="resetBtn">Clear All</button>
            <a class="btn btn-outline-primary ms-auto" href="@Url.Action("InitiateManual", "BulkEmail")">Back to Sessions</a>
        </div>
    </form>

    <div class="progress mb-3 d-none" id="progressWrap" style="height:20px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:0%" id="uploadProgress">0%</div>
    </div>

    <div id="summary" class="d-none card shadow-sm">
        <div class="card-header">Session Created</div>
        <div class="card-body">
            <p id="summaryText" class="mb-2"></p>
            <div id="counts" class="mb-3"></div>
            <div class="d-flex gap-2">
                <a id="gotoSessions" class="btn btn-success" href="@Url.Action("InitiateManual", "BulkEmail")">Go to Sessions</a>
                <button class="btn btn-outline-secondary" id="uploadMore">Upload More</button>
            </div>
        </div>
    </div>

    <div class="small text-muted mt-4">
        <ul>
            <li>ZIP bomb protection: very large archives may be rejected.</li>
            <li>Session auto-cleanup after configured retention period.</li>
        </ul>
    </div>
</div>

@section Scripts {
<script>
(function(){
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const chooseBtn = document.getElementById('chooseBtn');
    const fileList = document.getElementById('fileList');
    const form = document.getElementById('zipForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('uploadProgress');
    const summary = document.getElementById('summary');
    const summaryText = document.getElementById('summaryText');
    const countsDiv = document.getElementById('counts');
    const uploadMore = document.getElementById('uploadMore');
    const alerts = document.getElementById('alerts');
    const countBadge = document.getElementById('countBadge');

    let files = [];
    let pickerOpen = false; // guard to prevent double-open

    function showAlert(type, msg){
        const e = document.createElement('div');
        e.className = `alert alert-${type} alert-dismissible fade show`;
        e.innerHTML = `<strong>${type === 'danger' ? 'Error' : 'Info'}:</strong> ${msg}<button type='button' class='btn-close' data-bs-dismiss='alert'></button>`;
        alerts.appendChild(e);
    }
    function clearAlerts(){ alerts.innerHTML=''; }

    function renderFiles(){
        countBadge.textContent = `${files.length} selected`;
        if(files.length===0){ fileList.innerHTML='<div class="text-muted">No files selected.</div>'; uploadBtn.disabled=true; return; }
        const list = files.map((f,idx)=>
            `<div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                <span>${f.name} <span class='text-muted'>(${(f.size/1024).toFixed(1)} KB)</span></span>
                <button type="button" class="btn btn-sm btn-outline-danger" data-idx="${idx}">Remove</button>
            </div>`
        ).join('');
        fileList.innerHTML = list;
        fileList.querySelectorAll('[data-idx]').forEach(btn => {
            btn.addEventListener('click', () => { files.splice(+btn.dataset.idx,1); renderFiles(); });
        });
        uploadBtn.disabled=false;
    }

    function addFiles(flist){
        let added = 0, skipped = 0;
        for(const f of flist){
            const isZipByName = f.name && f.name.toLowerCase().endsWith('.zip');
            const isZipByType = f.type && f.type.toLowerCase().includes('zip');
            if (!isZipByName && !isZipByType) { skipped++; continue; }
            // de-duplicate by name+size
            if (files.some(x => x.name === f.name && x.size === f.size)) continue;
            files.push(f); added++;
        }
        if (skipped>0) showAlert('info', `${skipped} file(s) skipped (not ZIP).`);
        if (added===0 && flist.length>0) showAlert('info', 'No new files added.');
        renderFiles();
    }

    chooseBtn.addEventListener('click',()=>{
        if (pickerOpen) return;
        pickerOpen = true;
        fileInput.click();
    });
    fileInput.addEventListener('change',e=>{ addFiles(e.target.files); pickerOpen = false; });
    fileInput.addEventListener('blur', ()=>{ pickerOpen = false; });

    dropZone.addEventListener('dragover',e=>{ e.preventDefault(); dropZone.classList.add('border-primary'); dropZone.classList.add('bg-white'); });
    dropZone.addEventListener('dragleave',()=> { dropZone.classList.remove('border-primary'); dropZone.classList.remove('bg-white'); });
    dropZone.addEventListener('drop',e=>{
        e.preventDefault(); dropZone.classList.remove('border-primary'); dropZone.classList.remove('bg-white');
        addFiles(e.dataTransfer.files);
    });

    resetBtn.addEventListener('click',()=>{ files=[]; renderFiles(); clearAlerts(); summary.classList.add('d-none'); });
    uploadMore.addEventListener('click',()=>{ files=[]; renderFiles(); summary.classList.add('d-none'); window.scrollTo({top:0,behavior:'smooth'}); });

    form.addEventListener('submit',async e=>{
        e.preventDefault(); clearAlerts();
        const codeInput = form.querySelector('input[name="customCode"]');
        const code = codeInput.value.trim();
        if(code && !/^\d{4,8}$/.test(code)){ showAlert('danger','Custom code must be 4–8 digits.'); return; }
        if(files.length===0){ showAlert('danger','Please select at least one ZIP.'); return; }

        const fd = new FormData();
        fd.append('customCode', code);
        const antiInput = form.querySelector('input[name="__RequestVerificationToken"]');
        if (antiInput && antiInput.value) fd.append('__RequestVerificationToken', antiInput.value);
        // Send all ZIPs; server now accepts any number of files
        for (const f of files) fd.append('files', f);

        progressWrap.classList.remove('d-none');
        progressBar.style.width='5%'; progressBar.textContent='Starting...';

        try{
            const resp = await fetch('@Url.Action("UploadZipsAjax","BulkEmail")', { method:'POST', body: fd, credentials: 'same-origin' });
            progressBar.style.width='60%'; progressBar.textContent='Processing...';

            const ct = resp.headers.get('content-type') || '';
            let json = null, text = null;
            if (ct.includes('application/json')) {
                json = await resp.json();
            } else {
                text = await resp.text();
                if (!resp.ok) throw new Error(text || `HTTP ${resp.status} ${resp.statusText}`);
                try { json = JSON.parse(text); } catch { throw new Error('Expected JSON response but server returned non-JSON content.'); }
            }

            progressBar.style.width='100%'; progressBar.textContent='Done';
            setTimeout(()=>progressWrap.classList.add('d-none'),800);

            if(!json || !json.ok){ showAlert('danger', (json && json.error) || 'Upload failed.'); return; }
            summary.classList.remove('d-none');
            summaryText.textContent = `Session ${json.sessionId} created with ${json.total} PDF(s).`;
            countsDiv.innerHTML = `<span class='badge bg-info text-dark me-1'>SOA: ${json.soa}</span>`+
                                  `<span class='badge bg-success me-1'>INV: ${json.inv}</span>`+
                                  `<span class='badge bg-warning text-dark me-1'>OD: ${json.od}</span>`+
                                  `<span class='badge bg-secondary'>Other: ${json.unk}</span>`;
            window.scrollTo({ top: summary.offsetTop - 40, behavior: 'smooth'});
        }catch(err){
            progressBar.style.width='0%'; progressBar.textContent='0%';
            setTimeout(()=>progressWrap.classList.add('d-none'),200);
            showAlert('danger', err.message || 'Upload failed');
        }
    });

    renderFiles();
})();
</script>
}
