@model socconvertor.Models.BulkEmail.SelectSessionsViewModel
@{
    ViewData["Title"] = "Bulk Email - Select Sessions";
    var crumbs = new List<socconvertor.Models.BreadcrumbItem>
    {
        new socconvertor.Models.BreadcrumbItem { Text = "Dashboard", Controller = "Home", Action = "Index" },
        new socconvertor.Models.BreadcrumbItem { Text = "Select Sessions", Active = true }
    };
}

@await Html.PartialAsync("_Breadcrumb", crumbs)

<div class="container mt-2">
    <h2>Select Session Folders</h2>
    <p class="text-muted">Pick one or more session folders from wwwroot/Temp to merge and send by email.</p>
    <p class="text-muted">Found <strong>@(Model.Sessions?.Count ?? 0)</strong> session(s).</p>
    <p class="small text-muted">Files without SOA / INV / OD tokens are counted as <span class="badge bg-secondary">UNKNOWN</span>. Origin badges: <span class="badge bg-primary">SPLIT</span> (created via PDF split) / <span class="badge bg-dark">ZIP</span> (uploaded ZIP).</p>

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            @foreach (var err in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <div>@err.ErrorMessage</div>
            }
        </div>
    }

    <form method="post" asp-action="InitiateManual">
        @Html.AntiForgeryToken()
        <div class="d-flex align-items-center mb-3 gap-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAll" />
                <label class="form-check-label" for="selectAll">Select All</label>
            </div>
            <div class="ms-auto" style="max-width: 360px;">
                <input type="text" class="form-control" id="sessionSearch" placeholder="Filter sessions..." value="@Model.Query" />
            </div>
        </div>

        <div class="mb-2 d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary origin-filter" data-origin="all">All</button>
            <button type="button" class="btn btn-sm btn-outline-primary origin-filter" data-origin="split">Split</button>
            <button type="button" class="btn btn-sm btn-outline-dark origin-filter" data-origin="zip">Zip</button>
        </div>

        <div class="card mb-3">
            <div class="card-header">Available Sessions (@(Model.Sessions?.Count ?? 0))</div>
            <div class="card-body">
                @if ((Model.Sessions?.Count ?? 0) == 0)
                {
                    <div class="text-muted">No sessions found in wwwroot/Temp.</div>
                }
                else
                {
                    <div id="sessionGrid" class="row row-cols-1 row-cols-md-2 g-2">
                        @for (int i = 0; i < (Model.Sessions?.Count ?? 0); i++)
                        {
                            var s = Model.Sessions![i];
                            <div class="col session-item" data-id="@s.Id">
                                <div class="border rounded p-2 d-flex flex-column gap-2">
                                    <div class="d-flex align-items-start gap-2">
                                        <input class="form-check-input session-checkbox mt-1" type="checkbox" name="SelectedSessionIds" id="sid_@i" value="@s.Id" />
                                        <label class="form-check-label" for="sid_@i">
                                            <code>@s.Id</code>
                                        </label>
                                    </div>
                                    <div class="small text-muted">
                                        <span class="badge bg-light text-dark border me-1">@s.PdfCount PDF</span>
                                        <span class="badge bg-light text-dark border me-1">@s.TotalSizeFormatted</span>
                                        <span class="badge bg-light text-dark border me-1">@s.LastModifiedUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</span>
                                        <span class="badge @(s.Origin == "split" ? "bg-primary" : s.Origin == "zip" ? "bg-dark" : "bg-secondary")">@s.Origin.ToUpperInvariant()</span>
                                    </div>
                                    <div class="small">
                                        <span class="badge bg-info text-dark me-1">SOA: @s.SoaCount</span>
                                        <span class="badge bg-success me-1">INV: @s.InvoiceCount</span>
                                        <span class="badge bg-warning text-dark me-1">OD: @s.OverdueCount</span>
                                        <span class="badge bg-secondary text-light">UNK: @s.UnknownCount</span>
                                    </div>
                                    <div class="d-flex flex-wrap gap-2">
                                        <a class="btn btn-sm btn-outline-primary" href="@Url.Action("ViewSession", "Pdf", new { folderId = s.Id })">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                        <a class="btn btn-sm btn-outline-success" href="@Url.Action("DownloadAll", "Pdf", new { folderId = s.Id })">
                                            <i class="bi bi-download"></i> Zip
                                        </a>
                                        <form class="d-inline" method="post" asp-action="DeleteSession" asp-controller="BulkEmail" onsubmit="return confirm('Delete session @s.Id ?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="folderId" value="@s.Id" />
                                            <input type="hidden" name="returnUrl" value="@Url.Action("InitiateManual", "BulkEmail")" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="mb-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i> Scan and Group Files
            </button>
            <a href="@Url.Action("Index", "Home")" class="btn btn-secondary">Cancel</a>
            <a href="@Url.Action("UploadZips", "BulkEmail")" class="btn btn-outline-primary ms-auto">Upload ZIPs</a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        (function() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = () => Array.from(document.querySelectorAll('.session-checkbox'));
            const items = () => Array.from(document.querySelectorAll('#sessionGrid .session-item'));
            const search = document.getElementById('sessionSearch');

            if (selectAll) {
                selectAll.addEventListener('change', function() {
                    checkboxes().forEach(cb => { if (!cb.closest('.session-item').classList.contains('d-none')) cb.checked = selectAll.checked; });
                });
            }

            if (search) {
                search.addEventListener('input', function() {
                    const q = this.value.toLowerCase();
                    items().forEach(it => {
                        const id = it.getAttribute('data-id')?.toLowerCase() || '';
                        const match = id.includes(q);
                        it.classList.toggle('d-none', !match);
                    });
                });
            }

            const originButtons = Array.from(document.querySelectorAll('.origin-filter'));
            originButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const origin = btn.getAttribute('data-origin');
                    originButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    items().forEach(it => {
                        if (origin === 'all') { it.classList.remove('d-none-origin'); return; }
                        const badge = it.querySelector('.badge.bg-primary, .badge.bg-dark, .badge.bg-secondary');
                        const otext = badge ? badge.textContent.trim().toLowerCase() : 'unknown';
                        const hide = otext !== origin;
                        it.classList.toggle('d-none-origin', hide);
                    });
                });
            });
        })();
    </script>
}
