@model socconvertor.Models.BulkEmail.BulkEmailSession
@{
    ViewData["Title"] = "Bulk Email - Preview";
    var crumbs = new List<socconvertor.Models.BreadcrumbItem>
    {
        new socconvertor.Models.BreadcrumbItem { Text = "Dashboard", Controller = "Home", Action = "Index" },
        new socconvertor.Models.BreadcrumbItem { Text = "Select Sessions", Controller = "BulkEmail", Action = "InitiateManual" },
        new socconvertor.Models.BreadcrumbItem { Text = "Preview", Active = true }
    };
}

@await Html.PartialAsync("_Breadcrumb", crumbs)

<div class="container-fluid mt-2">
    <h2>Bulk Email Preview</h2>
    <p class="text-muted">Edit recipient emails, review attachments, then Queue & Monitor.</p>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" role="alert">@TempData["ErrorMessage"]</div>
    }

    <div class="card mb-4">
        <div class="card-header bg-primary text-white"><h5 class="mb-0">Session Summary</h5></div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3"><strong>Total Debtors:</strong> @Model.TotalDebtors</div>
                <div class="col-md-3"><strong>Total Files:</strong> @Model.TotalFiles</div>
                <div class="col-md-3"><strong>Total Size:</strong> @Model.TotalSizeFormatted</div>
                <div class="col-md-3"><strong>Status:</strong> <span class="badge bg-info">@Model.Status</span></div>
            </div>
            <div class="row mt-2"><div class="col-md-12"><strong>Source Sessions:</strong> @string.Join(", ", Model.SourceSessionIds)</div></div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">Email Drafts (SOA/Invoice vs Overdue)</h5></div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <h6>SOA / Invoice</h6>
                    <label class="form-label" for="soaSubject">Subject</label>
                    <input type="text" id="soaSubject" class="form-control" />
                    <label class="form-label mt-2" for="soaBody">Body (HTML)</label>
                    <textarea id="soaBody" rows="6" class="form-control"></textarea>
                    <div class="form-text">Placeholders: {DebtorCode}, {FileCount}, {TotalSize}</div>
                </div>
                <div class="col-md-6">
                    <h6>Overdue Reminder</h6>
                    <label class="form-label" for="odSubject">Subject</label>
                    <input type="text" id="odSubject" class="form-control" />
                    <label class="form-label mt-2" for="odBody">Body (HTML)</label>
                    <textarea id="odBody" rows="6" class="form-control"></textarea>
                    <div class="form-text">Placeholders: {DebtorCode}, {FileCount}, {TotalSize}</div>
                </div>
            </div>
            <div class="mt-3 d-flex gap-2">
                <button id="saveDraftsBtn" class="btn btn-success btn-sm" type="button">Save Drafts</button>
                <span class="text-muted small">These two drafts are shared and editable. No create/delete.</span>
            </div>
        </div>
    </div>

    <div id="queueForm" class="mb-4">
        @Html.AntiForgeryToken()
        <input type="hidden" name="sessionId" value="@Model.SessionId" />

        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0">Email Template (for this run)</h5></div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label" for="subject">Subject</label>
                    <input type="text" id="subject" name="subject" class="form-control" value="Documents for {DebtorCode}" required />
                    <div class="form-text">Use placeholders: {DebtorCode}, {FileCount}, {TotalSize}</div>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="bodyTemplate">Body (HTML)</label>
                    <textarea id="bodyTemplate" name="bodyTemplate" rows="6" class="form-control" required>Dear Customer,<br/><br/>Please find attached {FileCount} document(s) for account {DebtorCode}.<br/>Total size: {TotalSize}<br/><br/>Regards</textarea>
                </div>
                <div class="mb-2">
                    <button id="applySoaInvBtn" type="button" class="btn btn-outline-primary btn-sm">Apply SOA/Invoice Draft</button>
                    <button id="applyOverdueBtn" type="button" class="btn btn-outline-warning btn-sm">Apply Overdue Draft</button>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0">Debtor Email Groups</h5></div>
            <div class="card-body">
                @if (Model.DebtorGroups == null || Model.DebtorGroups.Count == 0)
                {
                    <div class="text-muted">No debtor groups were produced. Ensure selected sessions contain PDF files.</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Debtor Code</th>
                                    <th style="width:320px;">Email Address</th>
                                    <th>Files</th>
                                    <th>Total Size</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.DebtorGroups.Count; i++)
                                {
                                    var g = Model.DebtorGroups[i];
                                    var collapseId = $"debtor-files-{i}";
                                    <tr data-debtor="@g.DebtorCode" data-filecount="@g.TotalFileCount" data-tsize="@g.TotalSizeFormatted">
                                        <td><strong>@g.DebtorCode</strong><input type="hidden" name="debtorCodes" value="@g.DebtorCode" /></td>
                                        <td>
                                            <input type="email" name="emailAddresses" value="@g.EmailAddress" class="form-control form-control-sm" placeholder="recipient@example.com" required />
                                        </td>
                                        <td>@g.TotalFileCount</td>
                                        <td>@g.TotalSizeFormatted</td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false" aria-controls="@collapseId">
                                                <i class="bi bi-eye"></i> Files
                                            </button>
                                        </td>
                                    </tr>
                                    <tr class="collapse bg-light" id="@collapseId">
                                        <td colspan="5">
                                            <div class="p-3">
                                                <strong>Attachments (@g.Attachments.Count):</strong>
                                                <ul class="list-unstyled mt-2 mb-0">
                                                    @foreach (var file in g.Attachments)
                                                    {
                                                        <li>
                                                            <i class="bi bi-file-earmark-pdf text-danger"></i> @file.FileName
                                                            <span class="badge bg-secondary">@file.Type</span>
                                                            <small class="text-muted"> (@file.SizeFormatted)</small>
                                                            <small class="text-info"> from @file.SourceSessionId</small>
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>

        <div class="d-flex align-items-center gap-2 mb-3">
            <button id="queueBtn" type="button" class="btn btn-primary btn-lg">
                <i class="bi bi-cloud-upload"></i> Queue &amp; Monitor
            </button>
            <a href="@Url.Action("InitiateManual","BulkEmail")" class="btn btn-secondary btn-lg">Back</a>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function(){
    const queueBtn = document.getElementById('queueBtn');
    const sessionIdInput = document.querySelector('input[name="sessionId"]');
    const subjectInput = document.getElementById('subject');
    const bodyInput = document.getElementById('bodyTemplate');
    const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');

    queueBtn.addEventListener('click', async function(e){
        e.preventDefault();
        queueBtn.disabled = true;
        queueBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Queuing...';

        const debtorCodes = Array.from(document.querySelectorAll('input[name="debtorCodes"]')).map(i => i.value);
        const emailInputs = Array.from(document.querySelectorAll('input[name="emailAddresses"]')).map(i => i.value);
        const mappings = {};
        for (let i = 0; i < debtorCodes.length; i++) {
            if (debtorCodes[i]) mappings[debtorCodes[i]] = emailInputs[i] || '';
        }

        const payload = {
            sessionId: sessionIdInput.value,
            subject: subjectInput.value,
            bodyTemplate: bodyInput.value,
            mappings: mappings
        };

        try {
            const resp = await fetch('@Url.Action("StartQueuedSendAjax","BulkEmail")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': tokenInput.value
                },
                body: JSON.stringify(payload)
            });

            if (!resp.ok) {
                const err = await resp.json().catch(() => ({ error: 'Request failed' }));
                throw new Error(err.error || 'Failed to queue');
            }

            const result = await resp.json();
            if (!result.ok) throw new Error(result.error || 'Unknown error');

            window.location.href = '@Url.Action("Progress","BulkEmail")?jobId=' + encodeURIComponent(result.jobId);
        } catch (err) {
            console.error('Queue error:', err);
            alert('Error queuing job: ' + (err.message || err));
            queueBtn.disabled = false;
            queueBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Queue &amp; Monitor';
        }
    });

    // Drafts load/save/apply
    const soaSubject = document.getElementById('soaSubject');
    const soaBody = document.getElementById('soaBody');
    const odSubject = document.getElementById('odSubject');
    const odBody = document.getElementById('odBody');

    async function loadDrafts(){
        const res = await fetch('@Url.Action("EmailDraftsJson","BulkEmail")');
        const j = await res.json();
        if (j && j.ok && j.drafts){
            soaSubject.value = j.drafts.soaInvSubject || soaSubject.value;
            soaBody.value = j.drafts.soaInvBody || soaBody.value;
            odSubject.value = j.drafts.overdueSubject || odSubject.value;
            odBody.value = j.drafts.overdueBody || odBody.value;
        }
    }

    async function saveDrafts(){
        const payload = {
            soaInvSubject: soaSubject.value,
            soaInvBody: soaBody.value,
            overdueSubject: odSubject.value,
            overdueBody: odBody.value
        };
        const res = await fetch('@Url.Action("SaveEmailDraftsAjax","BulkEmail")', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'RequestVerificationToken': tokenInput.value },
            body: JSON.stringify(payload)
        });
        const j = await res.json();
        if (!j.ok) { alert(j.error || 'Save failed'); return; }
        alert('Drafts saved');
    }

    document.getElementById('saveDraftsBtn').addEventListener('click', saveDrafts);
    document.getElementById('applySoaInvBtn').addEventListener('click', ()=>{
        subjectInput.value = soaSubject.value;
        bodyInput.value = soaBody.value;
    });
    document.getElementById('applyOverdueBtn').addEventListener('click', ()=>{
        subjectInput.value = odSubject.value;
        bodyInput.value = odBody.value;
    });

    loadDrafts();
})();
</script>
}
